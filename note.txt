
===========apt update upgrade
sudo apt update -y && sudo apt upgrade -y

===========add host
192.168.22.111 k8smaster1
192.168.22.112 k8smaster2
192.168.22.113 k8smaster3
========== create user devops
sudo adduser devops
sudo usermod -aG sudo devops
su devops
sudo whoami
cd /home/devops

==========reset k8s cluster
sudo kubeadm reset -f
sudo rm -rf /var/lib/etcd
sudo rm -rf /etc/kubernetes/manifests/*

=============set up cluster
sudo swapoff -a
sudo sed -i '/swap.img/s/^/#/' /etc/fstab

echo -e "overlay\nbr_netfilter" | sudo tee /etc/modules-load.d/containerd.conf
sudo modprobe overlay
sudo modprobe br_netfilter

echo "net.bridge.bridge-nf-call-ip6tables = 1" | sudo tee -a /etc/sysctl.d/kubernetes.conf
echo "net.bridge.bridge-nf-call-iptables = 1" | sudo tee -a /etc/sysctl.d/kubernetes.conf
echo "net.ipv4.ip_forward = 1" | sudo tee -a /etc/sysctl.d/kubernetes.conf
sudo sysctl --system

===docker and containerd
sudo apt install -y curl gnupg2 software-properties-common apt-transport-https ca-certificates
sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmour -o /etc/apt/trusted.gpg.d/docker.gpg
sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"

sudo apt update -y
sudo apt install -y containerd.io

containerd config default | sudo tee /etc/containerd/config.toml >/dev/null 2>&1
sudo sed -i 's/SystemdCgroup = false/SystemdCgroup = true/g' /etc/containerd/config.toml

sudo systemctl restart containerd
sudo systemctl enable containerd
sudo systemctl status containerd


=============k8s packages
echo "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.30/deb/ /" | sudo tee /etc/apt/sources.list.d/kubernetes.list
curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.30/deb/Release.key | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg

sudo apt update -y
sudo apt install -y kubelet kubeadm kubectl
sudo apt-mark hold kubelet kubeadm kubectl

====== masters
sudo kubeadm init --control-plane-endpoint "192.168.121.111:6443" --upload-certs

mkdir -p $HOME/.kube 
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config

kubectl apply -f https://raw.githubusercontent.com/projectcalico/calico/v3.27.5/manifests/calico.yaml
=========================master 2 and master 3
sudo kubeadm join 192.168.121.111:6443 --token g8u4z8.75fxn2z9x9bzxnhi \
        --discovery-token-ca-cert-hash sha256:19beb57246f6af5a79cb1572139e981bb3c1c279e696d86bbfde7164d2f237ca \
        --control-plane --certificate-key 1e615a59aee119665f79f369f276d5331c2b61bcc99040e0844f9d00401d4ebf

=========rancher run with SUDO
mkfs.ext4 -m 0 /dev/sdb
mkdir /data
echo "/dev/sdb  /data  ext4  defaults  0  0" | sudo tee -a /etc/fstab
mount -a
df -h

apt install docker.io -y
apt install docker-compose -y
docker -v && docker-compose -v

mkdir /data/rancher
cd /data/rancher

vi docker-compose.yml

version: '3'
services:
  rancher-server:
    image: rancher/rancher:v2.9.5
    container_name: rancher-server
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /data/rancher/data:/var/lib/rancher
    privileged: true

docker-compose up -d
docker ps -a
docker logs rancher-server 2>&1 | grep "Bootstrap Password:"

admin/53h3CVGjB3R182zs